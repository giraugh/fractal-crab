<!DOCTYPE html>
<html>
<head>
  <title>Fractal Crab</title>
	<style>
		html,
		body {
			width: 100%;
			margin: 0;
			padding: 0;
			background: #1b2c42;
			font-family: "Open Sans", sans-serif;
      display: flex;
			flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
			color: white;
			overscroll-behavior-x: none;
		}

		h1 {
			margin-block-end: 0;
		}

		canvas {
			image-rendering: crisp-edges;
      max-width: min(80vw, 80vh);
			background: #111f31;
			cursor: zoom-in;
			display: block;
			touch-action: none;
		}

		button {
			margin-block-start: 1em;
			padding: .5em 1.2em;
		}

		.canvas-wrapper {
      border-radius: .2em;
			position: relative;
			overflow: hidden;
		}

		.canvas-wrapper.loading {
			transition: filter .5s;
			filter: grayscale(.8);
		}

		.canvas-wrapper.loading > canvas {
			cursor: progress;
		}
		
		.canvas-wrapper:hover > #zoom-selection {
			border: 2px solid #111f31;
		}
		
		.canvas-wrapper:active > #zoom-selection {
			opacity: 1;
		}

		#zoom-selection {
			width: 50%;
			height: 50%;
			border: 2px solid transparent;
			box-sizing: border-box;
			position: absolute;
			top: 0;
			left: 0;
			border-radius: .2rem;
			pointer-events: none;
			opacity: .2;
		}
	</style>
</head>

<body>
	<h1>
		ðŸ¦€ Fractal Crab ðŸ¦€
	</h1>
	<p>
		Use the mouse and click to zoom!
	</p>
	<div class="canvas-wrapper">
		<canvas id="canvas" width="800" height="800"></canvas>
	</div>
	<button id="reset">Reset zoom</button>
	<script type="module">
		import init, { FractalCanvas } from "./pkg/fractal_crab.js"
		(async function main() {
			const canvas = document.querySelector('#canvas')
			const boundingBox = canvas.getBoundingClientRect()
			canvas.width = boundingBox.width// * devicePixelRatio
			canvas.height = boundingBox.height// * devicePixelRatio

			// wait for wasm to be actually loaded
			await init()
			const fractalCanvas = FractalCanvas.from_canvas(canvas)
		
			const loop = () => {
				fractalCanvas.draw()
				requestAnimationFrame(loop)
			}
			
			window.addEventListener('wheel', e => {
				e.preventDefault()
				fractalCanvas.zoom_view(-e.deltaY / 1000)
			}, { passive: false })
			
			let isDragging = false
			let previousPosition = null
			const moveSpeed = 0.002
			window.addEventListener('pointerdown', e => {
				e.preventDefault()
				isDragging = true
			})
			window.addEventListener('pointerup', e => {
				e.preventDefault()
				isDragging = false
				previousPosition = null
			})
			window.addEventListener('pointercancel', e => {
				e.preventDefault()
				isDragging = false
				previousPosition = null
			})
			window.addEventListener('pointermove', e => {
				e.preventDefault()
				if (isDragging) {
					if (previousPosition) {
						let [dx, dy] = [e.clientX - previousPosition[0], e.clientY - previousPosition[1]]
						fractalCanvas.move_view(dx * -moveSpeed, dy * -moveSpeed)
					}	
				}
				previousPosition = [e.clientX, e.clientY]
			})

			loop()

		})().catch(err => console.error('Error', err))
	</script>
</body>

</html>
